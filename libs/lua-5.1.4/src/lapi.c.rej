***************
*** 108,132 ****
  
  
  LUA_API void lua_xmove (lua_State *from, lua_State *to, int n) {
-   int i;
    if (from == to) return;
    lua_lock(to);
    api_checknelems(from, n);
    api_check(from, G(from) == G(to));
    api_check(from, to->ci->top - to->top >= n);
-   from->top -= n;
-   for (i = 0; i < n; i++) {
-     setobj2s(to, to->top++, from->top + i);
-   }
    lua_unlock(to);
  }
  
  
- LUA_API void lua_setlevel (lua_State *from, lua_State *to) {
-   to->nCcalls = from->nCcalls;
- }
- 
- 
  LUA_API lua_CFunction lua_atpanic (lua_State *L, lua_CFunction panicf) {
    lua_CFunction old;
    lua_lock(L);
--- 108,127 ----
  
  
  LUA_API void lua_xmove (lua_State *from, lua_State *to, int n) {
+   StkId f, t;
    if (from == to) return;
    lua_lock(to);
    api_checknelems(from, n);
    api_check(from, G(from) == G(to));
    api_check(from, to->ci->top - to->top >= n);
+   f = from->top;
+   t = to->top = to->top + n;
+   while (--n >= 0) setobj2s(to, --t, --f);
+   from->top = f;
    lua_unlock(to);
  }
  
  
  LUA_API lua_CFunction lua_atpanic (lua_State *L, lua_CFunction panicf) {
    lua_CFunction old;
    lua_lock(L);
